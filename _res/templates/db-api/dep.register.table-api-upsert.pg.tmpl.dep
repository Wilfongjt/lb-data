\c [[LB_DB_PREFIX]]_db


CREATE OR REPLACE FUNCTION
[[LB_DB_PREFIX]]_schema.[[api-name]](_token TEXT, _json JSONB) RETURNS JSONB
AS $$
    Declare rc jsonb;
    Declare _cur_row JSONB;

    Declare _anonymous JSONB;
    Declare _registrant JSONB;
    Declare _app_id TEXT;

    [[declare-upsert]]
  BEGIN
    _anonymous := current_setting('app.lb_register_anonymous')::jsonb;
    _registrant :=  current_setting('app.lb_register_registrant')::jsonb;

    -- figure out which token: app-token or user-token

    if [[LB_DB_PREFIX]]_schema.is_valid_token(_token, _registrant ->> 'role') then
		rc := '{"result":"2"}'::JSONB;
    elsif [[LB_DB_PREFIX]]_schema.is_valid_token(_token, _anonymous ->> 'role') then
		rc := '{"result":"1"}'::JSONB;
    else
        return '{"result": "0"}'::JSONB;
    end if;

    -- update or insert
    if
    	_json ? 'id'
    then
    	--update
    	rc := '{"result":"-2"}'::JSONB;

        -- check required attributes by type
    	    [[required_update_inputs]]

		-- get current json object
		select [[tbl-prefix]]_row as _usr
		  into _cur_row
		  from [[LB_DB_PREFIX]]_schema.[[api-table]]
		  where
		    [[where-clause]]

        rc := '{"result":"-2.1"}'::JSONB;

        -- handle the changes to base table
		-- update table object with input values

        BEGIN
            -- sync-json-values to table values
    	    [[update-sync-json-values]]

            -- all possible update combinations of updatable fields
            [[update_combos_format]]

        EXCEPTION

		    WHEN check_violation then
		        rc := '{"result":"-2.2"}'::JSONB;
		    WHEN others then
		        rc := '{"result":"-2.2"}'::JSONB;
        END;
		if not FOUND then
		  return format('{"result":"-2.2"}')::JSONB;
		end if;

	    rc := '{"result":"2"}'::JSONB;
    else

    	--BEGIN

    	    -- check required attributes by type
    	    [[required_insert_inputs]]

    	    -- set defaults just in case
    	    [[set-defaults]]

            -- sync json values to table values
    	    [[insert-sync-json-values]]

            -- validate
            if length(_password) < 8 then
                return '{"result":"-1.1"}'::JSONB;
            end if;

            -- remove pw before inserting

			rc := '{"result":"-1.2"}'::JSONB;
        BEGIN
            /* expected _json
            [[expected-insert]]
            */
			--insert-statement
			INSERT
              INTO [[LB_DB_PREFIX]]_schema.[[tbl-name]]
              (
                [[insert-columns]]
              ) VALUES (
                [[insert-values]]
              );
            rc := '{"result":"1"}'::JSONB;

		EXCEPTION
		    WHEN unique_violation THEN
		        rc := '{"result":"-1.3"}'::JSONB;
		    WHEN check_violation then
		        rc := '{"result":"-1.4"}'::JSONB;
		    WHEN others then
		        rc := '{"result":"-1.5"}'::JSONB;
		END;
    end if;
    RETURN rc;
  END;

$$ LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION
  [[LB_DB_PREFIX]]_schema.[[api-name]](
  TEXT, JSONB
  ) TO anonymous;

CREATE OR REPLACE FUNCTION
[[LB_DB_PREFIX]]_schema.[[api-name]](_json JSONB) RETURNS JSONB
AS $$
DECLARE _token TEXT;
DECLARE _jwt TEXT;
DECLARE _anonymous jsonb;
BEGIN
    _anonymous := current_setting('app.lb_register_anonymous')::JSONB-'password';
	_jwt := current_setting('app.lb_register_jwt')::JSONB ->> 'password';
	_token := sign(_anonymous::JSON, _jwt) ;
	return [[LB_DB_PREFIX]]_schema.[[api-name]](_token, _json);
END;
$$ LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION
  [[LB_DB_PREFIX]]_schema.[[api-name]](
  JSONB
  ) TO anonymous;
