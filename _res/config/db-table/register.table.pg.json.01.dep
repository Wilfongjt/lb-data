{
    "description":["Single table multiple interfaces"],
    "type": "table",
    "tbl-name": "register",
    "tbl-prefix": "reg",
    "tbl-tests": ["api"],
    "tbl-roles": ["registrant"],

    "dep-api-overwrite": "0",
    "dep-api-name": "register",
    "dep-api-table": "register",
    "dep-api-methods": ["upsert", "select"],
    "tbl-fields": [
        {
            "name": "id",
            "context": "pk",
            "type": "UUID",
            "crud": "RI",
            "search-context": "uuid"
        },{
            "name": "type",
            "context":"type",
            "type": "TEXT",
            "crud": "CRI",
            "search-context": "type"
        },{
            "name": "form",
            "context": "form",
            "description": "JSON record",
            "type": "JSONB",
            "crud": "FR"
        },{
            "name": "password",
            "context": "password",
            "description": "Passwords are stored in table row, but not in json row",
            "type": "TEXT",
            "crud": "Cu",
            "calculate": "encrypt(_password)"
        },{
            "name": "active",
            "context": "active",
            "type": "BOOLEAN",
            "default": "true",
            "crud": "ru"
        },{
            "name": "created",
            "context": "created",
            "type": "TIMESTAMP",
            "crud": "r"
        },{
            "name": "updated",
            "context": "updated",
            "type": "TIMESTAMP",
            "crud": "r"
        }
    ],
    "interfaces": {
        "app": {
            "overwrite": "0",
            "name": "app",
            "table": "register",
            "methods": ["upsert", "select", "test"],
            "role": "anonymous",
            "version": "1.0.0",
            "privileges": [
                {
                    "privilege": "EXECUTE",
                    "type": "FUNCTION",
                    "parameters": "JSONB",
                    "role": "anonymous"
                }
            ],
            "form":[
                {
                    "name": "id",
                    "context": "uuid",
                    "type": "UUID",
                    "json": "RI",
                    "search": "uuid",
                    "calculated": "uuid_generate_v4()"
                }, {
                    "name": "type",
                    "context": "type",
                    "type": "TEXT",
                    "json": "CRI",
                    "const": "app"
                }, {
                    "name": "app-name",
                    "context": "name",
                    "type": "TEXT",
                    "json": "CRI",
                    "default": "my-app"
                }, {
                    "name": "version",
                    "context": "version",
                    "type": "TEXT",
                    "default": "1.0.0",
                    "json": "CR"
                }, {
                    "name": "username",
                    "context": "email",
                    "type": "TEXT",
                    "json": "Cru"
                }, {
                    "name": "password",
                    "context": "password",
                    "description": ["Passwords are stored in table row, but not in json row",
                                    "Remove the password from form before inserting",
                                    "Remove the password from form before updating"],
                    "type": "TEXT",
                    "json": "CuD"
                }, {
                    "name": "token",
                    "context": "token",
                    "type": "TEXT",
                    "json": "r",
                    "function": "sign(_payload, _secret)"
                }
            ],

            "test-forms": [
                {"type": "insert",
                    "pattern":   {
                        "username":"testuser@register.com",
                        "role":"anonymous"
                    },
                    "form": {
                        "type": "app",
                        "app-name": "my-test-app",
                        "version": "1.0.0",
                        "username": "testuser@register.com",
                        "email": "test@register.com",
                        "password": "g1G!gggg",
                        "test": "insert"
                    }
                },
                {"type": "update",
                    "form": {
                        "id": "xxxxxxx",
                        "type": "app",
                        "app-name": "my-test-app",
                        "version": "1.0.0",
                        "username": "testuser@register.com",
                        "email": "test@register.com",
                        "password": "g1G!gggg",
                        "test": "update"
                    }
                }
            ]
        },
        "user": {
            "overwrite": "0",
            "name": "user",
            "table": "register",
            "methods": ["upsert", "select", "test"],
            "role": "registrant",
            "version": "1.0.0",

            "privileges": [
                {
                    "privilege": "EXECUTE",
                    "type": "FUNCTION",
                    "parameters": "TEXT, JSONB",
                    "role": "anonymous"
                }
            ],
            "form": [
                {
                    "name": "id",
                    "context": "uuid",
                    "type": "UUID",
                    "json": "RI",
                    "search": "uuid",
                    "calculated": "uuid_generate_v4()"
                }, {
                    "name": "type",
                    "context": "type",
                    "type": "TEXT",
                    "json": "CRI",
                    "dep-default": "user",
                    "const": "user"
                }, {
                    "name": "app_id",
                    "context": "fk-uuid",
                    "type": "UUID",
                    "json": "CRI",
                    "default": "my-app",
                    "calculated": "get_app_id(_token)"
                }, {
                    "name": "username",
                    "context": "email",
                    "type": "TEXT",
                    "json": "CRu"
                }, {
                    "name": "password",
                    "context": "password",
                    "description": ["Passwords are stored in table row, but not in json row",
                                    "Remove the password from form before inserting",
                                    "Remove the password from form before updating"],
                    "type": "TEXT",
                    "json": "CuD",
                    "calculated": "encrypt(_password)",
                    "remove": 1
                }
            ],

            "test-forms": [
                {"type": "insert",
                    "pattern":   {
                        "username":"testuser@register.com",
                        "app-id": "my-test-app@1.0.0",
                        "role":"registrar"
                    },
                    "form": {
                        "type": "user",
                        "app-id": "my-test-app",
                        "version": "1.0.0",
                        "username": "testuser@register.com",
                        "email": "test@register.com",
                        "password": "g1G!gggg",
                        "test": "insert"
                    }
                },
                {"type": "update",
                    "token": "sign('{\"username\":\"testuser@register.com\",\"role\":\"registrant\"}'::json, current_setting('app.jwt_secret'))",
                    "form": {
                        "id": "xxxxxxx",
                        "type": "user",
                        "app-id": "my-test-app",
                        "version": "1.0.0",
                        "username": "testuser@register.com",
                        "email": "test@register.com",
                        "password": "g1G!gggg",
                        "test": "update"
                    }
                }
            ]
        }
    }
}